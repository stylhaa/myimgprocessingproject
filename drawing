import cv2
import numpy as np
import matplotlib.pyplot as plt
from skimage.filters import threshold_multiotsu

image_path = r"C:\Users\user\.spyder-py3\drawing.jpg"
gray = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)

if gray is None:
    print("Error: Image not found.")
    exit()

blur = cv2.GaussianBlur(gray, (5, 5), 0)

_, otsu = cv2.threshold(
    blur,
    0,
    255,
    cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU
)
  
kernel = np.ones((3, 3), np.uint8)
cleaned = cv2.morphologyEx(otsu, cv2.MORPH_OPEN, kernel)

# Multi-Otsu separates intensity into multiple regions
# This is used to observe tonal variation, NOT pressure
thresholds = threshold_multiotsu(blur, classes=3)
regions = np.digitize(blur, bins=thresholds)

# Normalize regions for display
multi_otsu = (regions * (255 / regions.max())).astype(np.uint8)

pixels = blur.reshape((-1, 1)).astype(np.float32)
K = 3

_, labels, centers = cv2.kmeans(
    pixels,
    K,
    None,
    (cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, 50, 0.2),
    10,
    cv2.KMEANS_RANDOM_CENTERS
)

kmeans_img = centers[labels.flatten()].reshape(gray.shape).astype(np.uint8)

plt.figure(figsize=(24, 6))

plt.subplot(1, 6, 1)
plt.title("Original Grayscale")
plt.imshow(gray, cmap="gray")
plt.axis("off")

plt.subplot(1, 6, 2)
plt.title("Gaussian Blur")
plt.imshow(blur, cmap="gray")
plt.axis("off")

plt.subplot(1, 6, 3)
plt.title("Single Otsu\n(One Stroke Class)")
plt.imshow(otsu, cmap="gray")
plt.axis("off")

plt.subplot(1, 6, 4)
plt.title("Morphology Cleaned")
plt.imshow(cleaned, cmap="gray")
plt.axis("off")

plt.subplot(1, 6, 5)
plt.title("Multi-level Otsu\n(Tonal Regions)")
plt.imshow(multi_otsu, cmap="gray")
plt.axis("off")

plt.subplot(1, 6, 6)
plt.title("K-Means (K=3)\nOver-segmentation")
plt.imshow(kmeans_img, cmap="gray")
plt.axis("off")

plt.tight_layout()
plt.show()

cv2.imwrite("grayscale.png", gray)
cv2.imwrite("single_otsu.png", otsu)
cv2.imwrite("cleaned_ink.png", cleaned)
cv2.imwrite("multi_otsu.png", multi_otsu)
cv2.imwrite("kmeans_comparison.png", kmeans_img)

print("Processing completed successfully.")
print("Multi-level Otsu thresholds:", thresholds)
